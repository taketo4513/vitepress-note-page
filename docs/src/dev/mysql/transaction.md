# 事务操作

## 定义

事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，**即这些操作要么同时成功，要么同时失败**。

举例

张三给李四转账1000块钱，张三银行账户的钱减少1000，而李四银行账户的钱要增加1000。 这一组操作就必须在一个事务的范围内，要么都成功，要么都失败。

注意

默认MySQL的事务是自动提交的，也就是说，当执行完一条DML语句时，MySQL会立即隐式的提交事务。

## 事务操作

查看事务提交方式

```sql
SELECT @@autocommit ;
```

设置事务提交方式

```sql
# 1 代表自动提交,0 代表手动提交
SET @@autocommit = 0 ;
```

开启事务

```sql
START TRANSACTION ;
# 或
BEGIN ;
```

提交事务

```sql
COMMIT;
```

回滚事务

```sql
ROLLBACK;
```

## 事务四大特性

**原子性（Atomicity）**：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。

**一致性（Consistency）**：事务完成时，必须使所有的数据都保持一致状态。

**隔离性（Isolation）**：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。

**持久性（Durability）**：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。

## 并发事务问题

### 赃读

一个事务读到另外一个事务还没有提交的数据。

![An image](/img/dev/mysql/14.png)

> 比如事务B读取到了事务A未提交的数据

### 不可重复读

一个事务先后读取同一条记录，但两次读取的数据不同，称之为不可重复读。

![An image](/img/dev/mysql/15.png)

> 事务A两次读取同一条记录，但是读取到的数据却是不一样的

### 幻读

一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了 "幻影"。

![An image](/img/dev/mysql/16.png)

## 事务隔离级别

为了解决并发事务所引发的问题，在数据库中引入了事务隔离级别。

| 隔离级别                  | 脏读  | 不可重复读 | 幻读  |
| ------------------------- | ----- | ---------- | ----- |
| **Read uncommitted**      | **√** | **√**      | **√** |
| **Read committed**        | **×** | **√**      | **√** |
| **Repeatable Read(默认)** | **×** | **×**      | **√** |
| **Serializable**          | **×** | **×**      | **×** |

查看事务隔离级别

```sql
SELECT @@TRANSACTION_ISOLATION;
```

设置事务隔离级别

```sql
SET 
    [ SESSION | GLOBAL ]
TRANSACTION ISOLATION LEVEL
    { READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE }
```

注意

事务隔离级别越高，数据越安全，但是性能越低。
