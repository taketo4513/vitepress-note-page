# 存储引擎

## MySQL体系结构

![An image](/img/dev/mysql/17.png)

连接层

最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户端验证它所具有的操作权限

服务层

第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。

引擎层

存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎。

存储层

主要是将数据存储在文件系统之上，并完成与存储引擎的交互

## 存储引擎

数据库存储引擎是数据库底层软件组件，数据库管理系统使用数据引擎进行创建、查询、更新和删除数据操作。

存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式 。

存储引擎是基于表的，而不是基于库的，所以存储引擎也可被称为表的类型。我们可以在创建表的时候，来指定选择的存储引擎，如果没有指定将自动选择默认的存储引擎。

数据库的存储引擎决定了表在计算机中的存储方式。不同的存储引擎提供不同的存储机制、索引技巧、锁定水平等功能，使用不同的存储引擎还可以获得特定的功能。

| 存储引擎  | 描述                                                         |
| --------- | ------------------------------------------------------------ |
| ARCHIVE   | 用于数据存档的引擎，数据被插入后就不能在修改了，且不支持索引。 |
| CSV       | 在存储数据时，会以逗号作为数据项之间的分隔符。               |
| BLACKHOLE | 会丢弃写操作，该操作会返回空内容。                           |
| FEDERATED | 将数据存储在远程数据库中，用来访问远程表的存储引擎。         |
| InnoDB    | 具备外键支持功能的事务处理引擎                               |
| MEMORY    | 置于内存的表                                                 |
| MERGE     | 用来管理由多个 MyISAM 表构成的表集合                         |
| MyISAM    | 主要的非事务处理存储引擎                                     |
| NDB       | MySQL 集群专用存储引擎                                       |

查询当前数据库支持的存储引擎

```sql
show engines;
```

![An image](/img/dev/mysql/18.png)

建表时指定存储引擎

```sql
CREATE TABLE 表名( 
		字段1 字段1类型 [ COMMENT 字段1注释 ] , 
		...... 
		字段n 字段n类型 [COMMENT 字段n注释 ] 
) ENGINE = INNODB [ COMMENT 表注释 ] ; 
```

查询建表语句中默认的存储引擎

```sql
show create table account; 
```

![An image](/img/dev/mysql/19.png)

## 逻辑存储结构

![An image](/img/dev/mysql/20.png)

- **表空间**：InnoDB存储引擎逻辑结构的最高层，ibd文件其实就是表空间文件，在表空间中可以 包含多个Segment段。 
- **段** : 表空间是由各个段组成的， 常见的段有数据段、索引段、回滚段等。InnoDB中对于段的管 理，都是引擎自身完成，不需要人为对其控制，一个段中包含多个区。
- **区**：区是表空间的单元结构，每个区的大小为1M。 默认情况下， InnoDB存储引擎页大小为 16K， 即一个区中一共有64个连续的页。 
- **页**：页是组成区的最小单元，页也是InnoDB 存储引擎磁盘管理的最小单元，每个页的大小默 认为 16KB。为了保证页的连续性，InnoDB 存储引擎每次从磁盘申请 4-5 个区。 
- **行**：InnoDB 存储引擎是面向行的，也就是说数据是按行进行存放的，在每一行中除了定义表时 所指定的字段以外，还包含两个隐藏字段(后面会详细介绍)

## 存储引擎特点

### InnoDB

InnoDB 是一种兼顾高可靠性和高性能的通用存储引擎，在 MySQL 5.5 之后，InnoDB 是默认的 MySQL 引擎。

特点

- DML 操作遵循 ACID 模型，支持**事务**
- **行级锁**，提高并发访问性能
- 支持**外键**约束，保证数据的完整性和正确性

文件

xxx.ibd：xxx代表表名，InnoDB 引擎的每张表都会对应这样一个表空间文件，存储该表的表结构（frm、sdi）、数据和索引。

查看 Mysql 变量

```sql
show variables like 'innodb_file_per_table'; 
```

> innodb_file_per_table：决定多张表共享一个表空间还是每张表对应一个表空间

![An image](/img/dev/mysql/21.png)

> 如果该参数开启，代表对于InnoDB引擎的表，每一张表都对应一个ibd文件。

我们直接打开MySQL的 数据存放目录： MySQL Server 8.0\Data ， 这个目录下有很多文件夹，不同的文件夹代表不同的数据库

![An image](/img/dev/mysql/22.png)

可以看到里面有很多的ibd文件，每一个ibd文件就对应一张表。

比如：我们有一张表 account，就有这样的一个account.ibd文件，而在这个ibd文件中不仅存放表结构、数据，还会存放该表对应的 索引信息。 

而该文件是基于二进制存储的，**不能直接使用记事本打开**，我们可以使用mysql提供的一 个指令 **ibd2sdi** ，通过该指令就可以从ibd文件中提取sdi信息。

![An image](/img/dev/mysql/23.png)

### MyISAM

MyISAM是MySQL早期的默认存储引擎。

特点

- 不支持事务
- 不支持外键 支持表锁
- 不支持行锁 访问速度快

文件

- xxx.sdi：存储表结构信息
- xxx.MYD：存储数据
- xxx.MYI：存储索引

### Memory

Memory引擎的表数据时存储在内存中的，由于受到硬件问题、或断电问题的影响，只能将这些表作为 临时表或缓存使用。

特点

- 内存存放 hash索引（默认）

文件

- xxx.sdi：存储表结构信息

## 存储引擎区别

| **特点**     | **InnoDB**          | **MyISAM** | **Memory** |
| ------------ | ------------------- | ---------- | ---------- |
| 存储限制     | 64TB                | 有         | 有         |
| 事务安全     | 支持                | -          | -          |
| 锁机制       | 行锁                | 表锁       | 表锁       |
| B+tree索引   | 支持                | 支持       | 支持       |
| Hash索引     | -                   | -          | 支持       |
| 全文索引     | 支持（5.6版本之后） | 支持       | -          |
| 空间使用     | 高                  | 低         | N/A        |
| 内存使用     | 高                  | 低         | 中等       |
| 批量插入速度 | 低                  | 高         | 高         |
| 支持外键     | 支持                | -          | -          |

面试题

InnoDB引擎与MyISAM引擎的区别 ?

- InnoDB引擎, 支持事务, 而MyISAM不支持。
- InnoDB引擎, 支持行锁和表锁, 而MyISAM仅支持表锁, 不支持行锁。
- InnoDB引擎, 支持外键, 而MyISAM是不支持的。

主要是上述三点区别，当然也可以从索引结构、存储限制等方面，更加深入的回答，具体参考如下官方文档：

[innodb-introduction](https://dev.mysql.com/doc/refman/8.0/en/innodb-introduction.html)

[myisam-storage-engine](https://dev.mysql.com/doc/refman/8.0/en/myisam-storage-engine.html)

## 存储引擎选择

在选择存储引擎时，**应该根据应用系统的特点选择合适的存储引擎**。

对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。

`InnoDB`：如果应用对事物的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，则 InnoDB 是比较合适的选择

`MyISAM`：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不高，那这个存储引擎是非常合适的。

`Memory`：将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。Memory 的缺陷是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性

> 电商中的足迹和评论适合使用 `MyISAM` 引擎，缓存适合使用 `Memory` 引擎。
